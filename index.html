<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RC-chat - AI Chatbot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Starry Background */
        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            overflow: hidden;
        }

        .star-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background: radial-gradient(200% 100% at 50% 0%, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.9) 100%);
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(1px 1px at 50px 100px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 150px 200px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 250px 50px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 350px 180px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 450px 250px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 550px 120px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 650px 300px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 750px 70px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 850px 220px, #fff, rgba(0,0,0,0)),
                radial-gradient(1px 1px at 950px 150px, #fff, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 20px 30px, #eee, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 80px 70px, #eee, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 150px 10px, #eee, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 200px 90px, #eee, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 250px 50px, #eee, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 300px 20px, #eee, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 350px 80px, #eee, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 400px 40px, #eee, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 450px 60px, #eee, rgba(0,0,0,0)),
                radial-gradient(1.5px 1.5px at 500px 100px, #eee, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 10px 10px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 60px 120px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 110px 20px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 160px 150px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 210px 80px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 260px 190px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 310px 30px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 360px 100px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 410px 210px, #ddd, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 460px 40px, #ddd, rgba(0,0,0,0));
            background-size: 500px 500px, 700px 700px, 900px 900px;
            animation: move-stars 200s linear infinite;
        }

        @keyframes move-stars {
            from { background-position: 0 0, 0 0, 0 0; }
            to { background-position: 100% 100%, 200% 200%, 300% 300%; }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #1a1a1a;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            width: 80%;
            max-width: 500px;
            color: white;
            transition: all 0.3s ease-in-out;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #f00;
            text-decoration: none;
            cursor: pointer;
        }

        /* Custom button styles for glow and hover */
        .btn-glow-red {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
        }
        .btn-glow-red:hover {
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7), 0 0 25px rgba(255, 0, 0, 0.5);
            transform: scale(1.02);
        }
        .btn-glow-red:active {
            transform: scale(0.98);
        }

        /* Chat item styles */
        .chat-item-hover {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .chat-item-hover:hover {
            background-color: #2a2a2a;
            transform: translateX(5px);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        .chat-item-active {
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        /* Input focus glow */
        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.5);
        }

        /* Message bubble shadow */
        .message-bubble-shadow {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .message-bubble-user {
            box-shadow: 0 2px 5px rgba(255, 0, 0, 0.3);
        }
    </style>
</head>
<body class="text-white">
    <!-- Starry Background -->
    <div class="star-bg">
        <div class="stars"></div>
    </div>

    <div id="app" class="flex flex-col h-screen relative z10">
        <!-- Header -->
        <header class="bg-gray-900 text-white p-4 shadow-lg rounded-b-lg transition-all duration-300 ease-in-out">
            <h1 class="text-3xl font-bold text-center">RC-chat</h1>
            <p class="text-sm text-center mt-1 opacity-90">Your AI Chatbot for GitHub</p>
            <p id="user-id-display" class="text-xs text-center mt-2 opacity-80"></p>
            <p id="firebase-status" class="text-xs text-center mt-1 opacity-70">Connecting to Firebase...</p>
            <div id="auth-loading-indicator" class="flex items-center justify-center text-gray-500 hidden">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-gray-500"></div>
                <p class="ml-2">Authenticating...</p>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Side Panel -->
            <aside id="side-panel" class="w-64 bg-gray-900 p-4 border-r border-gray-700 flex flex-col shadow-lg transition-all duration-300 ease-in-out">
                <button id="new-chat-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-full mb-4 btn-glow-red" disabled>
                    <i class="fas fa-plus mr-2"></i> New Chat
                </button>
                <div class="flex-1 overflow-y-auto custom-scrollbar">
                    <h2 class="text-lg font-semibold mb-3 text-gray-300">Previous Chats</h2>
                    <ul id="chat-list" class="space-y-2"></ul>
                </div>
                <button id="settings-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-full mt-4 btn-glow-red" disabled>
                    <i class="fas fa-cog mr-2"></i> Settings
                </button>
            </aside>

            <!-- Chat Area -->
            <main class="flex-1 flex flex-col bg-gray-800">
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                    <div id="loading-chat-indicator" class="flex items-center justify-center h-full text-gray-500 hidden">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-500"></div>
                        <p class="ml-3">Loading chat...</p>
                    </div>
                    <div id="no-chat-selected-message" class="flex items-center justify-center h-full text-gray-500">
                        <p>Select a chat or start a new one!</p>
                    </div>
                </div>

                <!-- Message Input Area -->
                <div class="p-4 bg-gray-900 border-t border-gray-700 shadow-lg rounded-t-lg transition-all duration-300 ease-in-out">
                    <div class="flex space-x-3">
                        <input
                            type="text"
                            id="message-input"
                            class="flex-1 p-3 border border-gray-600 bg-gray-700 text-white rounded-full focus:outline-none focus:ring-0 input-glow transition-all duration-200"
                            placeholder="Type your message..."
                            aria-label="Type your message"
                            disabled
                        />
                        <button
                            id="send-button"
                            class="px-6 py-3 rounded-full font-semibold text-white btn-glow-red bg-red-600 hover:bg-red-700 active:scale-95"
                            disabled
                        >
                            Send
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <h2 class="text-2xl font-bold mb-4">Settings</h2>
            <div class="mb-4">
                <label for="ai-api-select" class="block text-gray-300 text-sm font-bold mb-2">
                    Select AI Model:
                </label>
                <select id="ai-api-select" class="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline focus:border-red-600 transition-all duration-200">
                    <option value="gemini">Gemini (Current)</option>
                    <option value="chatgpt">ChatGPT (Simulated)</option>
                    <option value="deepseek">DeepSeek (Simulated)</option>
                    <option value="grok">Grok (Simulated)</option>
                    <option value="r4c-custom">R4C-Custom (Alpha - May have bugs)</option>
                    <option value="other-free">Other Free Models (Simulated)</option>
                </select>
                <p class="text-xs text-gray-400 mt-2">
                    Note: Only Gemini is directly integrated. Other models are simulated and will use Gemini as a fallback.
                    R4C-Custom uses a free open-source AI API for its database. Free models often require API keys or have usage limits.
                </p>
            </div>
            <button id="save-settings-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-full btn-glow-red">
                Save Settings
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAqu1Qi5RxbO6Y7crEup_RZlQzVj9ACofo",
            authDomain: "rcch-69836.firebaseapp.com",
            projectId: "rcch-69836",
            storageBucket: "rcch-69836.firebasestorage.app",
            messagingSenderId: "8389897019",
            appId: "1:8389897019:web:f10e610b643692139de51e",
            measurementId: "G-21YV7T999N"
        };

        const appId = 'rc-chat-prod';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let db, auth;
        const firebaseStatusDisplay = document.getElementById('firebase-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const authLoadingIndicator = document.getElementById('auth-loading-indicator');

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            firebaseStatusDisplay.textContent = "Firebase Connected. Authenticating...";
            authLoadingIndicator.classList.remove('hidden');
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            firebaseStatusDisplay.textContent = `Firebase Init Failed: ${error.message}`;
            userIdDisplay.textContent = "Firebase initialization failed.";
            authLoadingIndicator.classList.add('hidden');
            // Removed illegal return statement
            disableUI();
        }

        let currentUserId = null;
        let currentChatSessionId = null;
        let selectedAiModel = 'gemini';

        // DOM Elements
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const newChatButton = document.getElementById('new-chat-button');
        const chatList = document.getElementById('chat-list');
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeModalButton = settingsModal.querySelector('.close-button');
        const aiApiSelect = document.getElementById('ai-api-select');
        const saveSettingsButton = document.getElementById('save-settings-button');
        const loadingChatIndicator = document.getElementById('loading-chat-indicator');
        const noChatSelectedMessage = document.getElementById('no-chat-selected-message');

        // Utility Functions
        const disableUI = () => {
            newChatButton.disabled = true;
            settingsButton.disabled = true;
            messageInput.disabled = true;
            sendButton.disabled = true;
            const retryButton = document.createElement('button');
            retryButton.textContent = "Retry Connection";
            retryButton.className = "bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-full mt-2 btn-glow-red";
            retryButton.addEventListener('click', () => {
                location.reload(); // Simple retry by reloading
            });
            userIdDisplay.appendChild(retryButton);
        };

        const scrollToBottom = () => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        const displayMessage = (msg) => {
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-[70%] p-3 rounded-xl shadow-md message-bubble-shadow ${
                msg.sender === 'user' ? 'bg-red-600 text-white rounded-br-none message-bubble-user' : 'bg-gray-700 text-white rounded-bl-none'
            }`;
            const messageText = document.createElement('p');
            messageText.className = 'text-sm break-words';
            messageText.textContent = msg.message;
            const timestampText = document.createElement('p');
            timestampText.className = 'text-xs mt-1 opacity-75 text-right';
            timestampText.textContent = msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleTimeString() : 'Sending...';
            messageBubble.appendChild(messageText);
            messageBubble.appendChild(timestampText);
            messageElement.appendChild(messageBubble);
            messagesContainer.appendChild(messageElement);
        };

        const analyzeCharacterInput = (text) => {
            const charCounts = {};
            for (const char of text) {
                charCounts[char] = (charCounts[char] || 0) + 1;
            }
            console.log("Character analysis for input:", charCounts);
            return charCounts;
        };

        // Send Message
        const sendMessage = async () => {
            const messageText = messageInput.value.trim();
            if (!messageText || !db || !currentUserId || !currentChatSessionId) {
                console.warn("Cannot send message: Input is empty, DB not ready, or User ID/Chat Session is missing.");
                firebaseStatusDisplay.textContent = "Error: Cannot send message. Check console.";
                return;
            }

            messageInput.value = '';
            messageInput.disabled = true;
            sendButton.disabled = true;

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/chatSessions/${currentChatSessionId}/messages`), {
                    userId: currentUserId,
                    sender: 'user',
                    message: messageText,
                    timestamp: serverTimestamp(),
                    charAnalysis: analyzeCharacterInput(messageText)
                });

                const aiLoadingIndicator = document.createElement('div');
                aiLoadingIndicator.id = 'ai-loading-indicator';
                aiLoadingIndicator.className = 'flex justify-start';
                aiLoadingIndicator.innerHTML = `
                    <div class="max-w-[70%] p-3 rounded-xl shadow-md bg-gray-700 text-white rounded-bl-none message-bubble-shadow">
                        <div class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-500 mr-2"></div>
                            <p class="text-sm">RC-chat is thinking...</p>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(aiLoadingIndicator);
                scrollToBottom();

                const chatHistory = [{ role: "user", parts: [{ text: messageText }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Replace with your Gemini API key or inject via environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                let aiResponseText;

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    aiResponseText = result.candidates[0].content.parts[0].text;
                } else {
                    console.error("AI response structure unexpected:", result);
                    aiResponseText = "I'm sorry, I couldn't generate a response at this time. Please try again.";
                }

                if (selectedAiModel !== 'gemini') {
                    aiResponseText = `${selectedAiModel.toUpperCase()} (Simulated): ${aiResponseText}`;
                    if (selectedAiModel === 'r4c-custom') {
                        aiResponseText = `R4C-Custom (Alpha - May have bugs): ${aiResponseText}`;
                    }
                }

                await addDoc(collection(db, `artifacts/${appId}/public/data/chatSessions/${currentChatSessionId}/messages`), {
                    userId: currentUserId,
                    sender: 'ai',
                    message: aiResponseText,
                    timestamp: serverTimestamp(),
                    charAnalysis: analyzeCharacterInput(aiResponseText)
                });

            } catch (error) {
                console.error("Error sending message or getting AI response:", error);
                await addDoc(collection(db, `artifacts/${appId}/public/data/chatSessions/${currentChatSessionId}/messages`), {
                    userId: currentUserId,
                    sender: 'ai',
                    message: "An error occurred while trying to get a response. Please check your connection.",
                    timestamp: serverTimestamp()
                });
                firebaseStatusDisplay.textContent = `Error: ${error.message}`;
            } finally {
                const existingAiLoadingIndicator = document.getElementById('ai-loading-indicator');
                if (existingAiLoadingIndicator) {
                    existingAiLoadingIndicator.remove();
                }
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
                scrollToBottom();
            }
        };

        // Load Chat Session
        const loadChatSession = async (sessionId) => {
            if (!db || !currentUserId) {
                console.warn("Cannot load chat: DB or User ID missing.");
                firebaseStatusDisplay.textContent = "Error: Database or user not ready.";
                return;
            }

            currentChatSessionId = sessionId;
            messagesContainer.innerHTML = '';
            loadingChatIndicator.classList.remove('hidden');
            noChatSelectedMessage.classList.add('hidden');
            messageInput.disabled = false;
            sendButton.disabled = false;

            document.querySelectorAll('#chat-list li').forEach(item => {
                item.classList.remove('bg-red-700', 'chat-item-active');
            });
            const selectedChatItem = document.getElementById(`chat-item-${sessionId}`);
            if (selectedChatItem) {
                selectedChatItem.classList.add('bg-red-700', 'chat-item-active');
            }

            const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/chatSessions/${sessionId}/messages`);
            const q = query(messagesCollectionRef, orderBy('timestamp', 'asc'));

            onSnapshot(q, (snapshot) => {
                messagesContainer.innerHTML = '';
                if (snapshot.empty) {
                    messagesContainer.innerHTML = '<p class="text-gray-500 text-center">No messages in this chat yet. Start typing!</p>';
                } else {
                    snapshot.docs.forEach(doc => {
                        displayMessage(doc.data());
                    });
                }
                loadingChatIndicator.classList.add('hidden');
                scrollToBottom();
            }, (error) => {
                console.error("Error fetching messages for session:", sessionId, error);
                loadingChatIndicator.classList.add('hidden');
                messagesContainer.innerHTML = '<p class="text-red-400 text-center">Error loading messages.</p>';
                firebaseStatusDisplay.textContent = `Error loading messages: ${error.message}`;
            });
        };

        // Start New Chat
        const startNewChat = async () => {
            if (!db || !currentUserId) {
                console.warn("Cannot start new chat: DB or User ID missing.");
                firebaseStatusDisplay.textContent = "Error: Database or user not ready.";
                return;
            }

            try {
                const newChatRef = await addDoc(collection(db, `artifacts/${appId}/public/data/chatSessions`), {
                    userId: currentUserId,
                    name: `Chat ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`,
                    createdAt: serverTimestamp(),
                    lastUpdated: serverTimestamp()
                });
                console.log("New chat session created with ID:", newChatRef.id);
                await loadChatSession(newChatRef.id);
            } catch (error) {
                console.error("Error creating new chat session:", error);
                firebaseStatusDisplay.textContent = `Error creating chat: ${error.message}`;
            }
        };

        // Render Chat Sessions
        const renderChatSessions = (sessions) => {
            chatList.innerHTML = '';
            if (sessions.length === 0) {
                chatList.innerHTML = '<li class="text-gray-400 text-sm">No chats yet. Click "New Chat" to begin!</li>';
                return;
            }
            sessions.forEach(session => {
                const listItem = document.createElement('li');
                listItem.id = `chat-item-${session.id}`;
                listItem.className = `p-3 rounded-lg cursor-pointer transition duration-200 text-gray-200 chat-item-hover ${
                    session.id === currentChatSessionId ? 'bg-red-700 chat-item-active' : 'bg-gray-800'
                }`;
                listItem.setAttribute('role', 'button');
                listItem.setAttribute('aria-label', `Select chat: ${session.name}`);
                listItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>${session.name.length > 30 ? session.name.substring(0, 27) + '...' : session.name}</span>
                        <button class="delete-chat-button text-red-400 hover:text-red-600" aria-label="Delete chat: ${session.name}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                listItem.querySelector('.delete-chat-button').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete chat "${session.name}"?`)) {
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/chatSessions`, session.id));
                            if (currentChatSessionId === session.id) {
                                currentChatSessionId = null;
                                messagesContainer.innerHTML = '';
                                noChatSelectedMessage.classList.remove('hidden');
                            }
                            firebaseStatusDisplay.textContent = `Chat "${session.name}" deleted.`;
                        } catch (error) {
                            console.error("Error deleting chat session:", error);
                            firebaseStatusDisplay.textContent = `Error deleting chat: ${error.message}`;
                        }
                    }
                });
                listItem.addEventListener('click', () => loadChatSession(session.id));
                chatList.appendChild(listItem);
            });
        };

        // Authentication with Timeout
        const authenticateWithTimeout = async () => {
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error("Authentication timed out after 10 seconds.")), 10000);
            });

            try {
                const authPromise = new Promise((resolve, reject) => {
                    onAuthStateChanged(auth, (user) => {
                        console.log("onAuthStateChanged triggered. User:", user);
                        if (user) {
                            resolve(user);
                        } else if (initialAuthToken) {
                            console.log("Using provided initialAuthToken for sign-in.");
                            signInWithCustomToken(auth, initialAuthToken)
                                .then(() => console.log("Successfully signed in with custom token."))
                                .catch(reject);
                        } else {
                            console.log("No initialAuthToken. Attempting anonymous sign-in.");
                            signInAnonymously(auth)
                                .then(() => console.log("Successfully signed in anonymously."))
                                .catch(reject);
                        }
                    }, reject);
                });

                const user = await Promise.race([authPromise, timeoutPromise]);
                currentUserId = user.uid;
                userIdDisplay.textContent = `Your User ID: ${currentUserId}`;
                firebaseStatusDisplay.textContent = "Authenticated.";
                authLoadingIndicator.classList.add('hidden');
                newChatButton.disabled = false;
                settingsButton.disabled = false;

                // Load chat sessions
                const chatSessionsCollectionRef = collection(db, `artifacts/${appId}/public/data/chatSessions`);
                const q = query(chatSessionsCollectionRef, orderBy('lastUpdated', 'desc'));

                onSnapshot(q, async (snapshot) => {
                    const fetchedSessions = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderChatSessions(fetchedSessions);

                    if (!currentChatSessionId && fetchedSessions.length > 0) {
                        await loadChatSession(fetchedSessions[0].id);
                    } else if (!currentChatSessionId && fetchedSessions.length === 0) {
                        console.log("No existing chat sessions found. Starting a new chat.");
                        await startNewChat();
                    }
                }, (error) => {
                    console.error("Error fetching chat sessions:", error);
                    firebaseStatusDisplay.textContent = `Error fetching chats: ${error.message}`;
                });
            } catch (error) {
                console.error("Authentication error:", error);
                firebaseStatusDisplay.textContent = `Authentication Failed: ${error.message}`;
                userIdDisplay.textContent = "Authentication failed. Please try again.";
                authLoadingIndicator.classList.add('hidden');
                disableUI();
            }
        };

        // Initialize Authentication
        authenticateWithTimeout();

        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        newChatButton.addEventListener('click', startNewChat);
        settingsButton.addEventListener('click', () => {
            aiApiSelect.value = selectedAiModel;
            settingsModal.style.display = 'flex';
        });
        closeModalButton.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });
        window.addEventListener('click', (event) => {
            if (event.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });
        saveSettingsButton.addEventListener('click', () => {
            selectedAiModel = aiApiSelect.value;
            console.log("AI Model set to:", selectedAiModel);
            settingsModal.style.display = 'none';
        });
    </script>
</body>
</html>
